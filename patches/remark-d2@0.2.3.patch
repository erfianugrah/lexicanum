diff --git a/src/index.js b/src/index.js
index eff2c868842db41d14ce6d3d243585eece70625c..247a49e7cdd31c60d20317b9a31d75df02d9e3cb 100644
--- a/src/index.js
+++ b/src/index.js
@@ -1,7 +1,7 @@
 "use strict";
 
 import { visit } from "unist-util-visit";
-import { spawn } from "node:child_process";
+import { spawn, spawnSync } from "node:child_process";
 import path from "node:path";
 import { existsSync, mkdirSync } from "node:fs";
 import { createImage, parseImageAttributeString } from "./util.js";
@@ -116,15 +116,14 @@ export default function remarkD2(opts) {
       if (!lang || lang !== "d2") return;
       const image = `${count}.${opts.ext}`;
 
-      // TODO: if failing, report!
-      // if errcode 1, dump stdout
-      const d2 = spawn("d2", [
+      // Use spawnSync so the SVG is written before the transform completes.
+      // This fixes the race condition where the dev server tries to serve
+      // the image before the async spawn has finished writing it.
+      const d2 = spawnSync("d2", [
         ...opts.defaultD2Opts,
         "-",
         `${path.join(compileDir, image)}`,
-      ]);
-      d2.stdin.write(value);
-      d2.stdin.end();
+      ], { input: value });
 
       const htmlImage = opts.htmlImage || meta;
       const urlPath = path.join(linkDir, image);
